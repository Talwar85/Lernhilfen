<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¢ Mathe-Abenteuer Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --purple: #A06CD5;
            --blue: #45B7D1;
            --green: #7BC74D;
            --orange: #FF9F43;
            --bg: #FFF9F0;
            --text: #2D3436;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            border-radius: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(69, 183, 209, 0.3);
        }

        h1 {
            color: white;
            font-size: 2.8rem;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .control-card h3 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-card h3 span {
            font-size: 1.5rem;
        }

        .operation-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .operation-btn {
            width: 70px;
            height: 70px;
            border: 3px solid #E0E0E0;
            border-radius: 15px;
            background: white;
            font-family: 'Comic Neue', cursive;
            font-size: 2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
        }

        .operation-btn:hover {
            transform: scale(1.1);
            border-color: var(--secondary);
        }

        .operation-btn.selected {
            background: var(--secondary);
            border-color: var(--secondary);
            color: white;
            transform: scale(1.05);
        }

        .operation-btn.plus { border-color: var(--green); }
        .operation-btn.plus.selected { background: var(--green); border-color: var(--green); }
        
        .operation-btn.minus { border-color: var(--orange); }
        .operation-btn.minus.selected { background: var(--orange); border-color: var(--orange); }
        
        .operation-btn.mult { border-color: var(--blue); }
        .operation-btn.mult.selected { background: var(--blue); border-color: var(--blue); }
        
        .operation-btn.div { border-color: var(--purple); }
        .operation-btn.div.selected { background: var(--purple); border-color: var(--purple); }

        .range-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .range-btn {
            padding: 15px;
            border: 3px solid #E0E0E0;
            border-radius: 15px;
            background: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .range-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .range-btn.selected {
            border-color: var(--blue);
            background: linear-gradient(135deg, #E3F2FD, #E8F5E9);
        }

        .options-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-group label {
            font-size: 1rem;
            color: var(--text);
        }

        select, input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            background: white;
        }

        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .generate-btn {
            width: 100%;
            padding: 20px 40px;
            background: linear-gradient(135deg, var(--orange), var(--primary));
            border: none;
            border-radius: 20px;
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(255, 159, 67, 0.4);
            margin-bottom: 30px;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 159, 67, 0.5);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        /* Mathe-Teppich Styles */
        .matheteppich-container {
            background: white;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .print-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .print-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-btn.primary {
            background: var(--primary);
            color: white;
        }

        .print-btn.secondary {
            background: var(--blue);
            color: white;
        }

        .print-btn:hover {
            transform: scale(1.05);
        }

        .print-hint {
            font-size: 0.9rem;
            color: #888;
            margin-top: 10px;
            padding: 10px 15px;
            background: #FFF9E6;
            border-radius: 10px;
            border-left: 4px solid var(--accent);
        }

        #matheteppich {
            background: white;
            padding: 40px;
            border: 4px dashed var(--blue);
            border-radius: 20px;
        }

        .teppich-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px dotted var(--accent);
        }

        .teppich-title {
            font-size: 2rem;
            color: var(--blue);
            margin-bottom: 5px;
        }

        .teppich-subtitle {
            font-size: 1.2rem;
            color: #888;
        }

        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-item-wrapper {
            display: flex;
            flex-direction: column;
        }

        .task-item {
            font-family: 'Comic Neue', cursive;
            font-size: var(--task-size, 1.8rem);
            font-weight: 700;
            padding: 15px 10px;
            background: linear-gradient(135deg, #F5F5FF, #F5FFFA);
            border-radius: 15px;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .task-item.task-long {
            font-size: calc(var(--task-size, 1.8rem) * 0.75);
        }

        .task-item.task-very-long {
            font-size: calc(var(--task-size, 1.8rem) * 0.6);
        }

        .task-item:nth-child(4n+1) { border-color: var(--green); }
        .task-item:nth-child(4n+2) { border-color: var(--orange); }
        .task-item:nth-child(4n+3) { border-color: var(--blue); }
        .task-item:nth-child(4n) { border-color: var(--purple); }

        .task-item .op {
            color: var(--primary);
            font-size: 1.2em;
        }

        /* Tracker Styles */
        .read-tracker {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 8px;
        }

        .read-tracker .check-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #888;
            border-radius: 50%;
            display: inline-block;
        }

        .tracker-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #E8F5E9, #E3F2FD);
            border-radius: 10px;
        }

        .tracker-header p {
            margin: 0;
            color: #555;
            font-size: 1rem;
        }

        .tracker-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 8px;
        }

        .tracker-legend span {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        .tracker-legend .check-circle {
            width: 16px;
            height: 16px;
            border: 2px solid #888;
            border-radius: 50%;
        }

        /* Malen nach Zahlen */
        .coloring-section {
            margin-top: 30px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            border: 3px dashed var(--accent);
            text-align: center;
        }

        .coloring-section h4 {
            font-size: 1.5rem;
            color: var(--text);
            margin-bottom: 10px;
        }

        .coloring-section p {
            color: #888;
            margin-bottom: 20px;
        }

        .coloring-image {
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }

        .coloring-image svg {
            max-width: 260px;
            height: auto;
        }

        .color-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 2px solid #333;
        }

        /* Custom Number Range */
        .custom-range {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #F5F5F5;
            border-radius: 10px;
        }

        .custom-range.visible {
            display: block;
        }

        .custom-range label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .custom-range input {
            width: 100px;
            margin-right: 15px;
        }

        /* Difficulty presets */
        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .difficulty-btn {
            padding: 12px;
            border: 3px solid #E0E0E0;
            border-radius: 12px;
            background: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .difficulty-btn:hover {
            border-color: var(--secondary);
        }

        .difficulty-btn.selected {
            border-color: var(--green);
            background: linear-gradient(135deg, #E8F5E9, #F1F8E9);
        }

        .difficulty-btn .emoji {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        /* Custom SVG Upload */
        .custom-svg-upload {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #F8F8F8;
            border-radius: 15px;
            border: 2px dashed #DDD;
        }

        .custom-svg-upload.visible {
            display: block;
        }

        .upload-area {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .upload-area p {
            margin: 5px 0;
            color: #666;
        }

        .upload-area button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Fredoka', sans-serif;
        }

        .upload-area button:hover {
            background: var(--blue);
        }

        .upload-hint {
            font-size: 0.85rem !important;
            color: #999 !important;
        }

        .svg-preview {
            text-align: center;
            margin-bottom: 15px;
        }

        .svg-preview svg {
            max-width: 200px;
            max-height: 150px;
            border: 2px solid #DDD;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .color-mapping {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .color-mapping-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
        }

        .color-mapping-item label {
            font-weight: 600;
            min-width: 20px;
        }

        .color-mapping-item input[type="color"] {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .color-mapping-item input[type="text"] {
            width: 80px;
            padding: 5px 8px;
            border: 2px solid #DDD;
            border-radius: 5px;
            font-family: 'Fredoka', sans-serif;
        }

        /* Print Styles - A4 optimiert */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
                font-size: 12pt;
            }

            .app-container > *:not(.matheteppich-container) {
                display: none !important;
            }

            .matheteppich-container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                border-radius: 0;
            }

            .print-controls {
                display: none !important;
            }

            .print-hint {
                display: none !important;
            }

            #matheteppich {
                border: 2px dashed #45B7D1 !important;
                padding: 15px;
                border-radius: 10px;
            }

            .teppich-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .teppich-title {
                font-size: 1.5rem !important;
            }

            .teppich-subtitle {
                font-size: 1rem !important;
            }

            .task-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 15px;
            }

            .task-item {
                font-size: 1.2rem !important;
                padding: 8px 6px !important;
                border-radius: 8px !important;
                border-width: 2px !important;
                break-inside: avoid;
                white-space: nowrap !important;
            }

            .task-item.task-long {
                font-size: 1rem !important;
            }

            .task-item.task-very-long {
                font-size: 0.85rem !important;
            }

            .task-item-wrapper {
                break-inside: avoid;
            }

            .coloring-section {
                margin-top: 15px;
                padding: 15px;
                break-inside: avoid;
                page-break-inside: avoid;
            }

            .coloring-section h4 {
                font-size: 1.2rem !important;
                margin-bottom: 5px;
            }

            .coloring-section p {
                font-size: 0.9rem !important;
                margin-bottom: 10px;
            }

            .coloring-image svg {
                max-width: 200px !important;
                max-height: 200px !important;
                width: auto !important;
                height: auto !important;
            }

            .color-legend {
                gap: 10px !important;
                margin-top: 10px;
            }

            .color-item {
                font-size: 0.9rem !important;
            }

            .color-swatch {
                width: 20px !important;
                height: 20px !important;
            }

            /* Tracker Print Styles */
            .tracker-header {
                margin-bottom: 10px;
                padding: 8px;
            }

            .tracker-header p {
                font-size: 0.85rem !important;
                margin-bottom: 5px;
            }

            .tracker-legend {
                gap: 10px !important;
            }

            .tracker-legend span {
                font-size: 0.8rem !important;
            }

            .read-tracker {
                margin-top: 5px;
                gap: 4px !important;
            }

            .read-tracker .check-circle,
            .tracker-legend .check-circle {
                border-color: #333 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }

            .operation-btn {
                width: 55px;
                height: 55px;
                font-size: 1.5rem;
            }

            .task-item {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>üî¢ Mathe-Abenteuer üî¢</h1>
            <p>Erstelle spannende Rechenaufgaben zum √úben!</p>
        </header>

        <div class="controls">
            <div class="control-card">
                <h3><span>‚ûï</span> Rechenarten ausw√§hlen</h3>
                <div class="operation-grid">
                    <button class="operation-btn plus selected" data-op="+" onclick="toggleOperation('+', this)">+</button>
                    <button class="operation-btn minus selected" data-op="-" onclick="toggleOperation('-', this)">‚àí</button>
                    <button class="operation-btn mult" data-op="*" onclick="toggleOperation('*', this)">√ó</button>
                    <button class="operation-btn div" data-op="/" onclick="toggleOperation('/', this)">√∑</button>
                </div>
                <div class="options-row">
                    <div class="option-group">
                        <input type="checkbox" id="noNegative" checked>
                        <label for="noNegative">Keine negativen Ergebnisse</label>
                    </div>
                </div>
                <div class="options-row">
                    <div class="option-group">
                        <input type="checkbox" id="limitResult" checked>
                        <label for="limitResult">Ergebnis maximal:</label>
                        <input type="number" id="maxResult" value="10" min="1" max="10000" style="width: 80px;">
                    </div>
                </div>
                <div class="options-row">
                    <div class="option-group">
                        <input type="checkbox" id="showResult">
                        <label for="showResult">Mit L√∂sungen (zum Kontrollieren)</label>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h3><span>üéØ</span> Schwierigkeit</h3>
                <div class="difficulty-grid">
                    <button class="difficulty-btn selected" onclick="setDifficulty('starter', this)">
                        <span class="emoji">üå±</span>
                        Starter (bis 10)
                    </button>
                    <button class="difficulty-btn" onclick="setDifficulty('easy', this)">
                        <span class="emoji">‚≠ê</span>
                        Leicht (bis 20)
                    </button>
                    <button class="difficulty-btn" onclick="setDifficulty('medium', this)">
                        <span class="emoji">üåü</span>
                        Mittel (bis 100)
                    </button>
                    <button class="difficulty-btn" onclick="setDifficulty('hard', this)">
                        <span class="emoji">üöÄ</span>
                        Schwer (bis 1000)
                    </button>
                    <button class="difficulty-btn" onclick="setDifficulty('einmaleins', this)">
                        <span class="emoji">‚úñÔ∏è</span>
                        1√ó1 (bis 10√ó10)
                    </button>
                    <button class="difficulty-btn" onclick="setDifficulty('custom', this)">
                        <span class="emoji">‚öôÔ∏è</span>
                        Eigene Werte
                    </button>
                </div>
                <div class="custom-range" id="customRange">
                    <div class="options-row">
                        <div class="option-group">
                            <label>Zahl 1 von:</label>
                            <input type="number" id="num1Min" value="1" min="0" max="10000">
                        </div>
                        <div class="option-group">
                            <label>bis:</label>
                            <input type="number" id="num1Max" value="20" min="0" max="10000">
                        </div>
                    </div>
                    <div class="options-row">
                        <div class="option-group">
                            <label>Zahl 2 von:</label>
                            <input type="number" id="num2Min" value="1" min="0" max="10000">
                        </div>
                        <div class="option-group">
                            <label>bis:</label>
                            <input type="number" id="num2Max" value="20" min="0" max="10000">
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h3><span>‚öôÔ∏è</span> Einstellungen</h3>
                <div class="options-row">
                    <div class="option-group">
                        <label>Anzahl Aufgaben:</label>
                        <input type="number" id="taskCount" value="12" min="4" max="30">
                    </div>
                    <div class="option-group">
                        <label>Schriftgr√∂√üe:</label>
                        <select id="fontSize">
                            <option value="1.4rem">Normal</option>
                            <option value="1.8rem" selected>Gro√ü</option>
                            <option value="2.2rem">Sehr gro√ü</option>
                            <option value="2.6rem">Riesig</option>
                        </select>
                    </div>
                </div>
                <div class="options-row">
                    <div class="option-group">
                        <input type="checkbox" id="includeTracker" checked>
                        <label for="includeTracker">√úbungs-Tracker</label>
                    </div>
                    <div class="option-group">
                        <label>Wie oft rechnen:</label>
                        <input type="number" id="practiceCount" value="3" min="1" max="5">
                    </div>
                </div>
                <div class="options-row">
                    <div class="option-group">
                        <input type="checkbox" id="includeColoring" checked>
                        <label for="includeColoring">Malen-nach-Zahlen</label>
                    </div>
                    <div class="option-group">
                        <label>Motiv:</label>
                        <select id="coloringType">
                            <option value="random">üé≤ Zuf√§llig</option>
                            <option value="custom">üì§ Eigenes SVG</option>
                            <option value="star">‚≠ê Stern</option>
                            <option value="heart">‚ù§Ô∏è Herz</option>
                            <option value="fish">üêü Fisch</option>
                            <option value="butterfly">ü¶ã Schmetterling</option>
                            <option value="rocket">üöÄ Rakete</option>
                            <option value="house">üè† Haus</option>
                            <option value="flower">üå∏ Blume</option>
                            <option value="cat">üê± Katze</option>
                            <option value="car">üöó Auto</option>
                            <option value="sun">‚òÄÔ∏è Sonne</option>
                            <option value="tree">üå≥ Baum</option>
                            <option value="boat">‚õµ Boot</option>
                            <option value="icecream">üç¶ Eis</option>
                            <option value="robot">ü§ñ Roboter</option>
                            <option value="rainbow">üåà Regenbogen</option>
                            <option value="snail">üêå Schnecke</option>
                            <option value="mushroom">üçÑ Pilz</option>
                        </select>
                    </div>
                </div>
                
                <!-- Custom SVG Upload -->
                <div class="custom-svg-upload" id="customSvgUpload">
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="svgFileInput" accept=".svg" style="display: none;">
                        <p>üì§ SVG-Datei hierher ziehen oder <button type="button" onclick="document.getElementById('svgFileInput').click()">Datei ausw√§hlen</button></p>
                        <p class="upload-hint">Das SVG sollte Zahlen (1, 2, 3...) in den Bereichen enthalten</p>
                    </div>
                    <div class="svg-preview" id="svgPreview"></div>
                    <div class="color-mapping" id="colorMapping"></div>
                </div>
            </div>
        </div>

        <button class="generate-btn" onclick="generateMatheteppich()">
            ‚ú® Mathe-Teppich erstellen! ‚ú®
        </button>

        <div class="matheteppich-container" id="outputContainer" style="display: none;">
            <div class="print-controls">
                <button class="print-btn primary" onclick="window.print()">
                    üñ®Ô∏è Drucken / PDF speichern
                </button>
                <button class="print-btn secondary" onclick="generateMatheteppich()">
                    üîÑ Neu generieren
                </button>
            </div>
            <p class="print-hint">üí° <strong>Tipp:</strong> 12 Aufgaben + Ausmalbild passen perfekt auf eine A4-Seite.</p>
            <div id="matheteppich"></div>
        </div>
    </div>

    <script>
        // Ausgew√§hlte Operationen
        let selectedOperations = new Set(['+', '-']);
        
        // Custom SVG Daten
        let customSvgData = null;
        let customColors = [];
        
        // Schwierigkeits-Einstellungen
        let difficulty = {
            num1Min: 1, num1Max: 10,
            num2Min: 1, num2Max: 10
        };

        // Event Listener f√ºr Motiv-Auswahl
        document.getElementById('coloringType').addEventListener('change', function() {
            const customUpload = document.getElementById('customSvgUpload');
            if (this.value === 'custom') {
                customUpload.classList.add('visible');
            } else {
                customUpload.classList.remove('visible');
            }
        });

        // SVG File Upload
        document.getElementById('svgFileInput').addEventListener('change', handleSvgUpload);
        
        // Drag & Drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--secondary)';
            uploadArea.style.background = '#F0FFF0';
        });
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#DDD';
            uploadArea.style.background = 'white';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#DDD';
            uploadArea.style.background = 'white';
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'image/svg+xml') {
                processSvgFile(file);
            }
        });

        function handleSvgUpload(e) {
            const file = e.target.files[0];
            if (file) {
                processSvgFile(file);
            }
        }

        function processSvgFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const svgContent = e.target.result;
                customSvgData = svgContent;
                
                // SVG Preview anzeigen
                document.getElementById('svgPreview').innerHTML = svgContent;
                
                // Zahlen im SVG finden
                const numbers = findNumbersInSvg(svgContent);
                
                // Farbzuordnung erstellen
                createColorMapping(numbers);
            };
            reader.readAsText(file);
        }

        function findNumbersInSvg(svgContent) {
            // Suche nach Zahlen in text-Elementen
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
            const textElements = svgDoc.querySelectorAll('text');
            
            const numbers = new Set();
            textElements.forEach(el => {
                const text = el.textContent.trim();
                if (/^\d+$/.test(text)) {
                    numbers.add(parseInt(text));
                }
            });
            
            // Sortiert zur√ºckgeben
            return [...numbers].sort((a, b) => a - b);
        }

        const defaultColors = [
            { color: '#FF6B6B', name: 'Rot' },
            { color: '#FF9F43', name: 'Orange' },
            { color: '#FFE66D', name: 'Gelb' },
            { color: '#7BC74D', name: 'Gr√ºn' },
            { color: '#45B7D1', name: 'Blau' },
            { color: '#A06CD5', name: 'Lila' },
            { color: '#4ECDC4', name: 'T√ºrkis' },
            { color: '#F8B4D9', name: 'Rosa' },
            { color: '#8B4513', name: 'Braun' },
            { color: '#78909C', name: 'Grau' }
        ];

        function createColorMapping(numbers) {
            const container = document.getElementById('colorMapping');
            container.innerHTML = '<p style="width:100%; margin-bottom:10px; font-weight:600;">üé® Farben zuordnen:</p>';
            
            customColors = [];
            
            numbers.forEach((num, index) => {
                const defaultColor = defaultColors[index % defaultColors.length];
                customColors.push({ num, color: defaultColor.color, name: defaultColor.name });
                
                const item = document.createElement('div');
                item.className = 'color-mapping-item';
                item.innerHTML = `
                    <label>${num} =</label>
                    <input type="color" value="${defaultColor.color}" onchange="updateCustomColor(${num}, this.value)">
                    <input type="text" value="${defaultColor.name}" placeholder="Farbname" onchange="updateCustomColorName(${num}, this.value)">
                `;
                container.appendChild(item);
            });
        }

        function updateCustomColor(num, color) {
            const colorItem = customColors.find(c => c.num === num);
            if (colorItem) colorItem.color = color;
        }

        function updateCustomColorName(num, name) {
            const colorItem = customColors.find(c => c.num === num);
            if (colorItem) colorItem.name = name;
        }

        function toggleOperation(op, btn) {
            if (selectedOperations.has(op)) {
                if (selectedOperations.size > 1) {
                    selectedOperations.delete(op);
                    btn.classList.remove('selected');
                }
            } else {
                selectedOperations.add(op);
                btn.classList.add('selected');
            }
        }

        function setDifficulty(level, btn) {
            // Button-Styling
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Custom-Range anzeigen/verstecken
            const customRange = document.getElementById('customRange');
            
            switch(level) {
                case 'starter':
                    difficulty = { num1Min: 1, num1Max: 10, num2Min: 1, num2Max: 10 };
                    document.getElementById('maxResult').value = 10;
                    customRange.classList.remove('visible');
                    break;
                case 'easy':
                    difficulty = { num1Min: 1, num1Max: 20, num2Min: 1, num2Max: 20 };
                    document.getElementById('maxResult').value = 20;
                    customRange.classList.remove('visible');
                    break;
                case 'medium':
                    difficulty = { num1Min: 1, num1Max: 100, num2Min: 1, num2Max: 100 };
                    document.getElementById('maxResult').value = 100;
                    customRange.classList.remove('visible');
                    break;
                case 'hard':
                    difficulty = { num1Min: 1, num1Max: 1000, num2Min: 1, num2Max: 1000 };
                    document.getElementById('maxResult').value = 1000;
                    customRange.classList.remove('visible');
                    break;
                case 'einmaleins':
                    difficulty = { num1Min: 1, num1Max: 10, num2Min: 1, num2Max: 10 };
                    document.getElementById('maxResult').value = 100;
                    // Nur Multiplikation aktivieren
                    selectedOperations.clear();
                    selectedOperations.add('*');
                    document.querySelectorAll('.operation-btn').forEach(b => {
                        b.classList.toggle('selected', b.dataset.op === '*');
                    });
                    customRange.classList.remove('visible');
                    break;
                case 'custom':
                    customRange.classList.add('visible');
                    break;
            }
            
            // Custom-Felder aktualisieren
            document.getElementById('num1Min').value = difficulty.num1Min;
            document.getElementById('num1Max').value = difficulty.num1Max;
            document.getElementById('num2Min').value = difficulty.num2Min;
            document.getElementById('num2Max').value = difficulty.num2Max;
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateTask() {
            const ops = [...selectedOperations];
            const op = ops[Math.floor(Math.random() * ops.length)];
            
            // Custom-Werte lesen falls sichtbar
            if (document.getElementById('customRange').classList.contains('visible')) {
                difficulty.num1Min = parseInt(document.getElementById('num1Min').value) || 1;
                difficulty.num1Max = parseInt(document.getElementById('num1Max').value) || 10;
                difficulty.num2Min = parseInt(document.getElementById('num2Min').value) || 1;
                difficulty.num2Max = parseInt(document.getElementById('num2Max').value) || 10;
            }
            
            const noNegative = document.getElementById('noNegative').checked;
            const limitResult = document.getElementById('limitResult').checked;
            const maxResult = parseInt(document.getElementById('maxResult').value) || 100;
            
            let num1, num2, result;
            let attempts = 0;
            
            do {
                num1 = getRandomInt(difficulty.num1Min, difficulty.num1Max);
                num2 = getRandomInt(difficulty.num2Min, difficulty.num2Max);
                
                switch(op) {
                    case '+':
                        result = num1 + num2;
                        break;
                    case '-':
                        // Bei keinen negativen Ergebnissen: gr√∂√üere Zahl zuerst
                        if (noNegative && num1 < num2) {
                            [num1, num2] = [num2, num1];
                        }
                        result = num1 - num2;
                        break;
                    case '*':
                        result = num1 * num2;
                        break;
                    case '/':
                        // Division: Ergebnis soll ganzzahlig sein
                        num2 = getRandomInt(Math.max(1, difficulty.num2Min), difficulty.num2Max);
                        result = getRandomInt(1, Math.min(10, maxResult));
                        num1 = num2 * result;
                        break;
                }
                
                attempts++;
            } while (limitResult && result > maxResult && attempts < 50);
            
            // Falls nach 50 Versuchen kein passendes Ergebnis, Zahlen anpassen
            if (limitResult && result > maxResult) {
                if (op === '+') {
                    num1 = getRandomInt(1, Math.floor(maxResult / 2));
                    num2 = getRandomInt(1, maxResult - num1);
                    result = num1 + num2;
                } else if (op === '*') {
                    num1 = getRandomInt(1, Math.floor(Math.sqrt(maxResult)));
                    num2 = getRandomInt(1, Math.floor(maxResult / num1));
                    result = num1 * num2;
                } else if (op === '-') {
                    num1 = getRandomInt(1, maxResult);
                    num2 = getRandomInt(1, num1);
                    result = num1 - num2;
                }
            }
            
            const opSymbol = op === '*' ? '√ó' : op === '/' ? '√∑' : op === '-' ? '‚àí' : op;
            
            return {
                num1,
                num2,
                op: opSymbol,
                result,
                display: `${num1} ${opSymbol} ${num2}`
            };
        }

        function generateTrackerCircles(count) {
            let circles = '';
            for (let i = 0; i < count; i++) {
                circles += '<span class="check-circle"></span>';
            }
            return circles;
        }

        // Malen nach Zahlen SVG-Vorlagen (gleich wie Leseteppich)
        const coloringTemplates = {
            star: {
                name: 'Stern',
                svg: `<svg viewBox="0 0 200 200" width="280" height="280">
                    <polygon points="100,10 120,75 190,75 135,115 155,180 100,145 45,180 65,115 10,75 80,75" 
                             fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="85" text-anchor="middle" font-size="24" font-weight="bold">1</text>
                    <polygon points="100,10 120,75 100,60 80,75" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="50" text-anchor="middle" font-size="16" font-weight="bold">2</text>
                    <polygon points="120,75 190,75 140,95" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="145" y="85" text-anchor="middle" font-size="16" font-weight="bold">3</text>
                    <polygon points="135,115 155,180 115,140" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="135" y="145" text-anchor="middle" font-size="16" font-weight="bold">4</text>
                    <polygon points="45,180 65,115 85,140" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="65" y="145" text-anchor="middle" font-size="16" font-weight="bold">5</text>
                    <polygon points="10,75 80,75 60,95" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="55" y="85" text-anchor="middle" font-size="16" font-weight="bold">6</text>
                </svg>`,
                colors: [{num: 1, color: '#FFE66D', name: 'Gelb'}, {num: 2, color: '#FF9F43', name: 'Orange'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rot'}, {num: 4, color: '#A06CD5', name: 'Lila'},
                         {num: 5, color: '#4ECDC4', name: 'T√ºrkis'}, {num: 6, color: '#45B7D1', name: 'Blau'}]
            },
            heart: {
                name: 'Herz',
                svg: `<svg viewBox="0 0 200 200" width="280" height="280">
                    <path d="M100,180 C60,140 10,100 10,60 C10,30 40,10 70,10 C85,10 100,25 100,25 C100,25 115,10 130,10 C160,10 190,30 190,60 C190,100 140,140 100,180 Z" 
                          fill="white" stroke="#333" stroke-width="2"/>
                    <ellipse cx="55" cy="55" rx="30" ry="25" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="55" y="62" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <ellipse cx="145" cy="55" rx="30" ry="25" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="145" y="62" text-anchor="middle" font-size="20" font-weight="bold">2</text>
                    <ellipse cx="100" cy="110" rx="50" ry="40" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="118" text-anchor="middle" font-size="24" font-weight="bold">3</text>
                    <path d="M70,145 Q100,175 130,145" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="160" text-anchor="middle" font-size="16" font-weight="bold">4</text>
                </svg>`,
                colors: [{num: 1, color: '#FF6B6B', name: 'Rot'}, {num: 2, color: '#FF9F43', name: 'Orange'}, 
                         {num: 3, color: '#FFE66D', name: 'Gelb'}, {num: 4, color: '#A06CD5', name: 'Lila'}]
            },
            fish: {
                name: 'Fisch',
                svg: `<svg viewBox="0 0 240 160" width="320" height="220">
                    <ellipse cx="110" cy="80" rx="70" ry="45" fill="white" stroke="#333" stroke-width="2"/>
                    <polygon points="180,80 230,40 230,120" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="65" cy="70" r="8" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="65" y="75" text-anchor="middle" font-size="12" font-weight="bold">1</text>
                    <ellipse cx="110" cy="60" rx="35" ry="18" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="110" y="66" text-anchor="middle" font-size="18" font-weight="bold">2</text>
                    <ellipse cx="110" cy="100" rx="35" ry="18" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="110" y="106" text-anchor="middle" font-size="18" font-weight="bold">3</text>
                    <polygon points="180,80 230,50 230,110" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="205" y="85" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <path d="M90,80 Q110,65 130,80" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="110" y="82" text-anchor="middle" font-size="12" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#2D3436', name: 'Schwarz'}, {num: 2, color: '#45B7D1', name: 'Blau'}, 
                         {num: 3, color: '#4ECDC4', name: 'T√ºrkis'}, {num: 4, color: '#FF9F43', name: 'Orange'},
                         {num: 5, color: '#FFE66D', name: 'Gelb'}]
            },
            butterfly: {
                name: 'Schmetterling',
                svg: `<svg viewBox="0 0 240 180" width="320" height="240">
                    <ellipse cx="120" cy="90" rx="8" ry="50" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="120" y="95" text-anchor="middle" font-size="14" font-weight="bold">1</text>
                    <ellipse cx="60" cy="60" rx="45" ry="35" fill="white" stroke="#333" stroke-width="2"/>
                    <ellipse cx="60" cy="60" rx="25" ry="20" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="60" y="45" text-anchor="middle" font-size="16" font-weight="bold">2</text>
                    <text x="60" y="80" text-anchor="middle" font-size="14" font-weight="bold">3</text>
                    <ellipse cx="180" cy="60" rx="45" ry="35" fill="white" stroke="#333" stroke-width="2"/>
                    <ellipse cx="180" cy="60" rx="25" ry="20" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="180" y="45" text-anchor="middle" font-size="16" font-weight="bold">2</text>
                    <text x="180" y="80" text-anchor="middle" font-size="14" font-weight="bold">3</text>
                    <ellipse cx="55" cy="125" rx="35" ry="30" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="55" y="130" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <ellipse cx="185" cy="125" rx="35" ry="30" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="185" y="130" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <path d="M115,45 Q105,20 95,25" fill="none" stroke="#333" stroke-width="2"/>
                    <path d="M125,45 Q135,20 145,25" fill="none" stroke="#333" stroke-width="2"/>
                    <circle cx="95" cy="25" r="5" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="145" cy="25" r="5" fill="white" stroke="#333" stroke-width="2"/>
                </svg>`,
                colors: [{num: 1, color: '#2D3436', name: 'Schwarz'}, {num: 2, color: '#A06CD5', name: 'Lila'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rot'}, {num: 4, color: '#FFE66D', name: 'Gelb'}]
            },
            rocket: {
                name: 'Rakete',
                svg: `<svg viewBox="0 0 160 240" width="220" height="320">
                    <path d="M80,10 L110,80 L110,160 L80,180 L50,160 L50,80 Z" fill="white" stroke="#333" stroke-width="2"/>
                    <rect x="55" y="85" width="50" height="60" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="80" y="122" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <polygon points="80,10 95,50 65,50" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="80" y="40" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <circle cx="80" cy="115" r="15" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="80" y="120" text-anchor="middle" font-size="16" font-weight="bold">3</text>
                    <polygon points="50,130 25,175 50,160" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="40" y="158" text-anchor="middle" font-size="14" font-weight="bold">4</text>
                    <polygon points="110,130 135,175 110,160" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="120" y="158" text-anchor="middle" font-size="14" font-weight="bold">4</text>
                    <polygon points="65,180 80,230 95,180" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="80" y="210" text-anchor="middle" font-size="16" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#E0E0E0', name: 'Grau'}, {num: 2, color: '#FF6B6B', name: 'Rot'}, 
                         {num: 3, color: '#45B7D1', name: 'Blau'}, {num: 4, color: '#FF9F43', name: 'Orange'},
                         {num: 5, color: '#FFE66D', name: 'Gelb'}]
            },
            house: {
                name: 'Haus',
                svg: `<svg viewBox="0 0 200 200" width="280" height="280">
                    <rect x="30" y="90" width="140" height="100" fill="white" stroke="#333" stroke-width="2"/>
                    <polygon points="100,20 180,90 20,90" fill="white" stroke="#333" stroke-width="2"/>
                    <rect x="30" y="90" width="60" height="100" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="60" y="145" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <rect x="110" y="90" width="60" height="100" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="140" y="145" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <polygon points="100,20 140,60 60,60" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="50" text-anchor="middle" font-size="16" font-weight="bold">2</text>
                    <polygon points="60,60 140,60 180,90 20,90" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="80" text-anchor="middle" font-size="16" font-weight="bold">3</text>
                    <rect x="75" y="130" width="50" height="60" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="165" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <rect x="45" y="105" width="25" height="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="57" y="122" text-anchor="middle" font-size="14" font-weight="bold">5</text>
                    <rect x="130" y="105" width="25" height="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="142" y="122" text-anchor="middle" font-size="14" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#FFE66D', name: 'Gelb'}, {num: 2, color: '#FF6B6B', name: 'Rot'}, 
                         {num: 3, color: '#A06CD5', name: 'Lila'}, {num: 4, color: '#7BC74D', name: 'Gr√ºn'},
                         {num: 5, color: '#45B7D1', name: 'Blau'}]
            },
            flower: {
                name: 'Blume',
                svg: `<svg viewBox="0 0 200 220" width="280" height="300">
                    <rect x="90" y="120" width="20" height="90" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="170" text-anchor="middle" font-size="16" font-weight="bold">1</text>
                    <ellipse cx="100" cy="90" rx="25" ry="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="95" text-anchor="middle" font-size="18" font-weight="bold">2</text>
                    <ellipse cx="60" cy="60" rx="25" ry="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="60" y="65" text-anchor="middle" font-size="18" font-weight="bold">3</text>
                    <ellipse cx="140" cy="60" rx="25" ry="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="140" y="65" text-anchor="middle" font-size="18" font-weight="bold">3</text>
                    <ellipse cx="55" cy="105" rx="25" ry="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="55" y="110" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <ellipse cx="145" cy="105" rx="25" ry="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="145" y="110" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <ellipse cx="100" cy="35" rx="25" ry="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="40" text-anchor="middle" font-size="18" font-weight="bold">5</text>
                    <ellipse cx="55" cy="175" rx="20" ry="12" transform="rotate(-30 55 175)" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="50" y="178" text-anchor="middle" font-size="12" font-weight="bold">6</text>
                    <ellipse cx="145" cy="175" rx="20" ry="12" transform="rotate(30 145 175)" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="150" y="178" text-anchor="middle" font-size="12" font-weight="bold">6</text>
                </svg>`,
                colors: [{num: 1, color: '#7BC74D', name: 'Gr√ºn'}, {num: 2, color: '#FFE66D', name: 'Gelb'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rot'}, {num: 4, color: '#FF9F43', name: 'Orange'},
                         {num: 5, color: '#A06CD5', name: 'Lila'}, {num: 6, color: '#4ECDC4', name: 'T√ºrkis'}]
            },
            cat: {
                name: 'Katze',
                svg: `<svg viewBox="0 0 200 220" width="280" height="300">
                    <ellipse cx="100" cy="140" rx="55" ry="60" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="145" text-anchor="middle" font-size="24" font-weight="bold">1</text>
                    <ellipse cx="100" cy="60" rx="40" ry="35" fill="white" stroke="#333" stroke-width="2"/>
                    <polygon points="65,40 50,5 75,30" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="62" y="25" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <polygon points="135,40 150,5 125,30" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="138" y="25" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <ellipse cx="82" cy="55" rx="10" ry="12" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="82" y="60" text-anchor="middle" font-size="12" font-weight="bold">3</text>
                    <ellipse cx="118" cy="55" rx="10" ry="12" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="118" y="60" text-anchor="middle" font-size="12" font-weight="bold">3</text>
                    <ellipse cx="100" cy="72" rx="6" ry="5" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="75" text-anchor="middle" font-size="8" font-weight="bold">4</text>
                    <path d="M155,140 Q180,130 190,145 Q180,155 155,150" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="172" y="148" text-anchor="middle" font-size="12" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#FF9F43', name: 'Orange'}, {num: 2, color: '#FFE66D', name: 'Gelb'}, 
                         {num: 3, color: '#7BC74D', name: 'Gr√ºn'}, {num: 4, color: '#FF6B6B', name: 'Rosa'},
                         {num: 5, color: '#FF9F43', name: 'Orange'}]
            },
            car: {
                name: 'Auto',
                svg: `<svg viewBox="0 0 260 160" width="340" height="210">
                    <path d="M30,100 L30,70 L70,70 L90,40 L180,40 L210,70 L240,70 L240,100 Z" fill="white" stroke="#333" stroke-width="2"/>
                    <rect x="35" y="75" width="35" height="20" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="52" y="90" text-anchor="middle" font-size="14" font-weight="bold">1</text>
                    <rect x="200" y="75" width="35" height="20" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="217" y="90" text-anchor="middle" font-size="14" font-weight="bold">1</text>
                    <polygon points="90,40 110,70 70,70" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="90" y="60" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <rect x="115" y="45" width="60" height="25" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="145" y="62" text-anchor="middle" font-size="14" font-weight="bold">3</text>
                    <polygon points="180,40 180,70 210,70" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="190" y="60" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <rect x="80" y="75" width="110" height="25" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="135" y="92" text-anchor="middle" font-size="16" font-weight="bold">4</text>
                    <circle cx="70" cy="110" r="22" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="70" cy="110" r="10" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="70" y="114" text-anchor="middle" font-size="12" font-weight="bold">5</text>
                    <circle cx="200" cy="110" r="22" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="200" cy="110" r="10" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="200" y="114" text-anchor="middle" font-size="12" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#FFE66D', name: 'Gelb'}, {num: 2, color: '#45B7D1', name: 'Blau'}, 
                         {num: 3, color: '#45B7D1', name: 'Blau'}, {num: 4, color: '#FF6B6B', name: 'Rot'},
                         {num: 5, color: '#2D3436', name: 'Schwarz'}]
            },
            sun: {
                name: 'Sonne',
                svg: `<svg viewBox="0 0 200 200" width="280" height="280">
                    <circle cx="100" cy="100" r="40" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="108" text-anchor="middle" font-size="24" font-weight="bold">1</text>
                    <line x1="100" y1="10" x2="100" y2="45" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="100" y1="155" x2="100" y2="190" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="10" y1="100" x2="45" y2="100" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="155" y1="100" x2="190" y2="100" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="30" y1="30" x2="55" y2="55" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="145" y1="145" x2="170" y2="170" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="170" y1="30" x2="145" y2="55" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <line x1="55" y1="145" x2="30" y2="170" stroke="#333" stroke-width="8" stroke-linecap="round"/>
                    <text x="100" y="30" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <text x="170" y="35" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <text x="185" y="105" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <text x="170" y="175" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                </svg>`,
                colors: [{num: 1, color: '#FFE66D', name: 'Gelb'}, {num: 2, color: '#FF9F43', name: 'Orange'}]
            },
            tree: {
                name: 'Baum',
                svg: `<svg viewBox="0 0 200 240" width="260" height="310">
                    <rect x="85" y="160" width="30" height="70" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="200" text-anchor="middle" font-size="18" font-weight="bold">1</text>
                    <polygon points="100,10 160,80 130,80 175,140 120,140 120,160 80,160 80,140 25,140 70,80 40,80" fill="white" stroke="#333" stroke-width="2"/>
                    <polygon points="100,10 130,50 70,50" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="40" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <polygon points="70,50 130,50 155,90 45,90" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="78" text-anchor="middle" font-size="14" font-weight="bold">3</text>
                    <polygon points="45,90 155,90 175,140 25,140" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="100" y="122" text-anchor="middle" font-size="16" font-weight="bold">4</text>
                </svg>`,
                colors: [{num: 1, color: '#8B4513', name: 'Braun'}, {num: 2, color: '#2E7D32', name: 'Dunkelgr√ºn'}, 
                         {num: 3, color: '#4CAF50', name: 'Gr√ºn'}, {num: 4, color: '#7BC74D', name: 'Hellgr√ºn'}]
            },
            boat: {
                name: 'Boot',
                svg: `<svg viewBox="0 0 240 200" width="300" height="250">
                    <path d="M20,130 L40,170 L200,170 L220,130 Z" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="120" y="158" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <rect x="110" y="50" width="10" height="80" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="115" y="95" text-anchor="middle" font-size="10" font-weight="bold">2</text>
                    <polygon points="120,30 120,120 200,120" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="150" y="100" text-anchor="middle" font-size="20" font-weight="bold">3</text>
                    <polygon points="110,40 110,110 50,110" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="85" y="95" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <path d="M0,180 Q60,160 120,180 Q180,200 240,180" fill="none" stroke="#333" stroke-width="3"/>
                    <text x="60" y="195" text-anchor="middle" font-size="14" font-weight="bold">5</text>
                    <text x="180" y="195" text-anchor="middle" font-size="14" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#8B4513', name: 'Braun'}, {num: 2, color: '#8B4513', name: 'Braun'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rot'}, {num: 4, color: '#FFE66D', name: 'Gelb'},
                         {num: 5, color: '#45B7D1', name: 'Blau'}]
            },
            icecream: {
                name: 'Eis',
                svg: `<svg viewBox="0 0 160 240" width="220" height="320">
                    <polygon points="80,240 40,100 120,100" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="80" y="180" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <circle cx="80" cy="70" r="35" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="80" y="78" text-anchor="middle" font-size="22" font-weight="bold">2</text>
                    <circle cx="55" cy="35" r="28" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="55" y="42" text-anchor="middle" font-size="18" font-weight="bold">3</text>
                    <circle cx="105" cy="35" r="28" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="105" y="42" text-anchor="middle" font-size="18" font-weight="bold">4</text>
                    <circle cx="80" cy="15" r="20" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="80" y="21" text-anchor="middle" font-size="14" font-weight="bold">5</text>
                </svg>`,
                colors: [{num: 1, color: '#DEB887', name: 'Beige'}, {num: 2, color: '#FF6B6B', name: 'Rosa'}, 
                         {num: 3, color: '#A06CD5', name: 'Lila'}, {num: 4, color: '#7BC74D', name: 'Gr√ºn'},
                         {num: 5, color: '#FFE66D', name: 'Gelb'}]
            },
            robot: {
                name: 'Roboter',
                svg: `<svg viewBox="0 0 180 220" width="240" height="290">
                    <rect x="50" y="50" width="80" height="70" rx="10" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="90" y="95" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <rect x="60" y="65" width="25" height="20" rx="5" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="72" y="80" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <rect x="95" y="65" width="25" height="20" rx="5" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="107" y="80" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <rect x="75" y="95" width="30" height="10" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="90" y="103" text-anchor="middle" font-size="8" font-weight="bold">3</text>
                    <line x1="90" y1="20" x2="90" y2="50" stroke="#333" stroke-width="3"/>
                    <circle cx="90" cy="15" r="8" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="90" y="19" text-anchor="middle" font-size="10" font-weight="bold">4</text>
                    <rect x="55" y="125" width="70" height="60" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="90" y="162" text-anchor="middle" font-size="18" font-weight="bold">5</text>
                    <rect x="20" y="130" width="30" height="15" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="35" y="142" text-anchor="middle" font-size="10" font-weight="bold">6</text>
                    <rect x="130" y="130" width="30" height="15" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="145" y="142" text-anchor="middle" font-size="10" font-weight="bold">6</text>
                    <rect x="60" y="190" width="20" height="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="70" y="207" text-anchor="middle" font-size="12" font-weight="bold">7</text>
                    <rect x="100" y="190" width="20" height="25" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="110" y="207" text-anchor="middle" font-size="12" font-weight="bold">7</text>
                </svg>`,
                colors: [{num: 1, color: '#B0BEC5', name: 'Silber'}, {num: 2, color: '#45B7D1', name: 'Blau'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rot'}, {num: 4, color: '#FFE66D', name: 'Gelb'},
                         {num: 5, color: '#B0BEC5', name: 'Silber'}, {num: 6, color: '#78909C', name: 'Grau'},
                         {num: 7, color: '#78909C', name: 'Grau'}]
            },
            rainbow: {
                name: 'Regenbogen',
                svg: `<svg viewBox="0 0 260 150" width="340" height="200">
                    <path d="M20,140 Q20,40 130,40 Q240,40 240,140" fill="none" stroke="#333" stroke-width="20"/>
                    <path d="M20,140 Q20,40 130,40 Q240,40 240,140" fill="none" stroke="white" stroke-width="18"/>
                    <path d="M35,140 Q35,55 130,55 Q225,55 225,140" fill="none" stroke="white" stroke-width="15"/>
                    <path d="M50,140 Q50,70 130,70 Q210,70 210,140" fill="none" stroke="white" stroke-width="15"/>
                    <path d="M65,140 Q65,85 130,85 Q195,85 195,140" fill="none" stroke="white" stroke-width="15"/>
                    <path d="M80,140 Q80,100 130,100 Q180,100 180,140" fill="none" stroke="white" stroke-width="15"/>
                    <text x="30" y="110" text-anchor="middle" font-size="14" font-weight="bold">1</text>
                    <text x="50" y="95" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <text x="70" y="82" text-anchor="middle" font-size="14" font-weight="bold">3</text>
                    <text x="95" y="72" text-anchor="middle" font-size="14" font-weight="bold">4</text>
                    <text x="130" y="65" text-anchor="middle" font-size="14" font-weight="bold">5</text>
                    <ellipse cx="50" cy="140" rx="30" ry="15" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="50" y="144" text-anchor="middle" font-size="12" font-weight="bold">6</text>
                    <ellipse cx="210" cy="140" rx="30" ry="15" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="210" y="144" text-anchor="middle" font-size="12" font-weight="bold">6</text>
                </svg>`,
                colors: [{num: 1, color: '#FF6B6B', name: 'Rot'}, {num: 2, color: '#FF9F43', name: 'Orange'}, 
                         {num: 3, color: '#FFE66D', name: 'Gelb'}, {num: 4, color: '#7BC74D', name: 'Gr√ºn'},
                         {num: 5, color: '#45B7D1', name: 'Blau'}, {num: 6, color: '#E0E0E0', name: 'Wei√ü'}]
            },
            snail: {
                name: 'Schnecke',
                svg: `<svg viewBox="0 0 240 160" width="320" height="210">
                    <ellipse cx="100" cy="120" rx="70" ry="30" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="100" y="128" text-anchor="middle" font-size="18" font-weight="bold">1</text>
                    <circle cx="130" cy="70" r="45" fill="white" stroke="#333" stroke-width="2"/>
                    <circle cx="130" cy="70" r="30" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="130" y="50" text-anchor="middle" font-size="14" font-weight="bold">2</text>
                    <circle cx="130" cy="70" r="15" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="130" y="75" text-anchor="middle" font-size="12" font-weight="bold">3</text>
                    <text x="130" y="95" text-anchor="middle" font-size="12" font-weight="bold">4</text>
                    <ellipse cx="45" cy="105" rx="15" ry="10" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="45" y="110" text-anchor="middle" font-size="12" font-weight="bold">5</text>
                    <path d="M35,105 Q25,70 30,50" fill="none" stroke="#333" stroke-width="3"/>
                    <circle cx="30" cy="45" r="5" fill="white" stroke="#333" stroke-width="2"/>
                    <path d="M50,100 Q55,75 60,55" fill="none" stroke="#333" stroke-width="3"/>
                    <circle cx="62" cy="50" r="5" fill="white" stroke="#333" stroke-width="2"/>
                </svg>`,
                colors: [{num: 1, color: '#FFE66D', name: 'Gelb'}, {num: 2, color: '#A06CD5', name: 'Lila'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rosa'}, {num: 4, color: '#4ECDC4', name: 'T√ºrkis'},
                         {num: 5, color: '#FFE66D', name: 'Gelb'}]
            },
            mushroom: {
                name: 'Pilz',
                svg: `<svg viewBox="0 0 180 200" width="240" height="260">
                    <rect x="70" y="110" width="40" height="80" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="90" y="160" text-anchor="middle" font-size="20" font-weight="bold">1</text>
                    <ellipse cx="90" cy="115" rx="75" ry="55" fill="white" stroke="#333" stroke-width="2"/>
                    <ellipse cx="60" cy="90" rx="15" ry="12" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="60" y="95" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <ellipse cx="110" cy="75" rx="12" ry="10" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="110" y="80" text-anchor="middle" font-size="10" font-weight="bold">2</text>
                    <ellipse cx="90" cy="110" rx="18" ry="14" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="90" y="115" text-anchor="middle" font-size="12" font-weight="bold">2</text>
                    <ellipse cx="130" cy="100" rx="10" ry="8" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="130" y="104" text-anchor="middle" font-size="8" font-weight="bold">2</text>
                    <ellipse cx="50" cy="110" rx="10" ry="8" fill="white" stroke="#333" stroke-width="1"/>
                    <text x="50" y="114" text-anchor="middle" font-size="8" font-weight="bold">2</text>
                    <text x="90" y="70" text-anchor="middle" font-size="18" font-weight="bold">3</text>
                    <path d="M55,192 Q70,185 90,190 Q110,195 125,190" fill="white" stroke="#333" stroke-width="2"/>
                    <text x="90" y="198" text-anchor="middle" font-size="10" font-weight="bold">4</text>
                </svg>`,
                colors: [{num: 1, color: '#F5F5DC', name: 'Beige'}, {num: 2, color: '#F5F5DC', name: 'Beige'}, 
                         {num: 3, color: '#FF6B6B', name: 'Rot'}, {num: 4, color: '#7BC74D', name: 'Gr√ºn'}]
            }
        };

        function generateMatheteppich() {
            const taskCount = parseInt(document.getElementById('taskCount').value);
            const fontSize = document.getElementById('fontSize').value;
            const includeTracker = document.getElementById('includeTracker').checked;
            const practiceCount = parseInt(document.getElementById('practiceCount').value);
            const includeColoring = document.getElementById('includeColoring').checked;
            const coloringType = document.getElementById('coloringType').value;
            const showResult = document.getElementById('showResult').checked;

            if (selectedOperations.size === 0) {
                alert('Bitte w√§hle mindestens eine Rechenart aus!');
                return;
            }

            // Aufgaben generieren (ohne Duplikate)
            const tasks = [];
            const usedTasks = new Set();
            let attempts = 0;
            
            while (tasks.length < taskCount && attempts < taskCount * 10) {
                const task = generateTask();
                const taskKey = `${task.num1}${task.op}${task.num2}`;
                
                if (!usedTasks.has(taskKey)) {
                    usedTasks.add(taskKey);
                    tasks.push(task);
                }
                attempts++;
            }

            // HTML generieren
            let html = `
                <div class="teppich-header">
                    <div class="teppich-title">üî¢ Mein Mathe-Abenteuer üî¢</div>
                    <div class="teppich-subtitle">Rechne alle Aufgaben!</div>
                </div>
            `;

            // Tracker-Legende
            if (includeTracker) {
                html += `
                    <div class="tracker-header">
                        <p>üìù Male einen Kreis aus, jedes Mal wenn du die Aufgabe gerechnet hast!</p>
                        <div class="tracker-legend">
                            ${Array.from({length: practiceCount}, (_, i) => `<span><span class="check-circle"></span> ${i + 1}√ó gerechnet</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            html += `<div class="task-grid" style="--task-size: ${fontSize}">`;

            tasks.forEach(task => {
                // Gr√∂√üenklasse basierend auf Aufgabenl√§nge
                const taskLength = task.display.length;
                let sizeClass = '';
                if (taskLength > 12) {
                    sizeClass = 'task-very-long';
                } else if (taskLength > 8) {
                    sizeClass = 'task-long';
                }
                
                const resultDisplay = showResult ? 
                    `<span style="color: #888;">= ${task.result}</span>` : 
                    '= ___';
                
                html += `<div class="task-item-wrapper">
                    <div class="task-item ${sizeClass}">
                        ${task.num1} <span class="op">${task.op}</span> ${task.num2} ${resultDisplay}
                    </div>
                    ${includeTracker ? `<div class="read-tracker">${generateTrackerCircles(practiceCount)}</div>` : ''}
                </div>`;
            });

            html += '</div>';

            // Malen nach Zahlen hinzuf√ºgen
            if (includeColoring) {
                let template;
                let svgContent;
                let colors;
                
                if (coloringType === 'custom' && customSvgData) {
                    // Custom SVG verwenden
                    svgContent = customSvgData;
                    colors = customColors;
                } else if (coloringType === 'custom' && !customSvgData) {
                    // Kein SVG hochgeladen, Fallback auf zuf√§llig
                    const templateKeys = Object.keys(coloringTemplates);
                    const randomKey = templateKeys[Math.floor(Math.random() * templateKeys.length)];
                    template = coloringTemplates[randomKey];
                    svgContent = template.svg;
                    colors = template.colors;
                } else if (coloringType === 'random') {
                    const templateKeys = Object.keys(coloringTemplates);
                    const randomKey = templateKeys[Math.floor(Math.random() * templateKeys.length)];
                    template = coloringTemplates[randomKey];
                    svgContent = template.svg;
                    colors = template.colors;
                } else {
                    template = coloringTemplates[coloringType];
                    svgContent = template.svg;
                    colors = template.colors;
                }

                html += `
                    <div class="coloring-section">
                        <h4>üé® Super gemacht! Male das Bild aus!</h4>
                        <p>Wenn du alles gerechnet hast, darfst du das Bild ausmalen.</p>
                        <div class="coloring-image">
                            ${svgContent}
                        </div>
                        <div class="color-legend">
                `;

                colors.forEach(c => {
                    html += `
                        <div class="color-item">
                            <div class="color-swatch" style="background: ${c.color}"></div>
                            <span>${c.num} = ${c.name}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            document.getElementById('matheteppich').innerHTML = html;
            document.getElementById('outputContainer').style.display = 'block';
            document.getElementById('outputContainer').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
